services:
  # MySQL Database
  mysql-db:
    image: mysql:8.0
    container_name: mysql-db
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hotel_booking}
      MYSQL_ROOT_HOST: '%'
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init-mysql:/docker-entrypoint-initdb.d
    networks:
      - hotel-booking-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p$MYSQL_ROOT_PASSWORD"]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 40s
    restart: unless-stopped
    command: 
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci

  # MongoDB
  mongodb:
    image: mongo:6.0
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE:-hotelbooking}
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
      - ./init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    networks:
      - hotel-booking-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')", "--quiet"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  # Zipkin Tracing
  zipkin:
    image: openzipkin/zipkin:latest
    container_name: zipkin
    ports:
      - "9411:9411"
    networks:
      - hotel-booking-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9411/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Keycloak
  # keycloak:
  #   image: quay.io/keycloak/keycloak:21.0.0
  #   container_name: keycloak
  #   environment:
  #     KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
  #     KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
  #     KC_HTTP_ENABLED: true
  #     KC_HOSTNAME_STRICT: false
  #     KC_HOSTNAME_STRICT_HTTPS: false
  #     KC_HEALTH_ENABLED: true
  #     KC_PROXY: passthrough
  #     KC_HTTP_PORT: 8080
  #   ports:
  #     - "8181:8080"
  #   command: 
  #     - start-dev
  #     - --import-realm
  #   volumes:
  #     - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json
  #   networks:
  #     - hotel-booking-network
  #   restart: on-failure
  #   mem_limit: 1g

  # Discovery Service (Eureka Server)
  discovery-service:
    build:
      context: .
      dockerfile: discovery_service/Dockerfile
    container_name: discovery-service
    hostname: discovery-service
    ports:
      - "8671:8671"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://zipkin:9411/api/v2/spans
      - JAVA_OPTS=-Xmx512m -Xms256m
      - EUREKA_INSTANCE_HOSTNAME=discovery-service
    networks:
      - hotel-booking-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://eureka:password@localhost:8671/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    restart: unless-stopped
    mem_limit: 512m

  # Redis
  redis:
    image: redis:alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - hotel-booking-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped
    
    
  # API Gateway
  api-gateway:
    build: 
      context: .
      dockerfile: api_gateway/Dockerfile
    container_name: api-gateway
    hostname: api-gateway
    ports:
      - "8900:8900"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICE-URL_DEFAULTZONE=http://discovery-service:8671/eureka/
      - MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://zipkin:9411/api/v2/spans
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER-URI=http://keycloak:8181/realms/hotelbooking
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK-SET-URI=http://keycloak:8181/realms/hotelbooking/protocol/openid-connect/certs
      - JAVA_OPTS=-Xmx512m -Xms256m
    depends_on:
      discovery-service:
        condition: service_healthy
      redis:
        condition: service_started
      user-service:
        condition: service_healthy
      hotel-service:
        condition: service_healthy
      order-service:
        condition: service_healthy
      payment-service:
        condition: service_healthy
    networks:
      - hotel-booking-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8900/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: on-failure
    mem_limit: 512m

  # User Service
  user-service:
    build: 
      context: .
      dockerfile: user_service/Dockerfile
    container_name: user-service
    hostname: user-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - MONGO_USERNAME=${MONGO_USERNAME}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-86400000}
      - EUREKA_CLIENT_SERVICE-URL_DEFAULTZONE=http://discovery-service:8671/eureka/
      - MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://zipkin:9411/api/v2/spans
      - JAVA_OPTS=-Xmx512m -Xms256m
    volumes:
      - user_logs:/app/logs
    depends_on:
      mongodb:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
      - hotel-booking-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: on-failure
    mem_limit: 512m

  # Hotel Service
  hotel-service:
    build: 
      context: .
      dockerfile: hotel_service/Dockerfile
    container_name: hotel-service
    hostname: hotel-service
    ports:
      - "8084:8084"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DB_USERNAME=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - EUREKA_CLIENT_SERVICE-URL_DEFAULTZONE=http://discovery-service:8671/eureka/
      - MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://zipkin:9411/api/v2/spans
      - JAVA_OPTS=-Xmx512m -Xms256m
    volumes:
      - hotel_uploads:/app/uploads
      - hotel_logs:/app/logs
    depends_on:
      mysql-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
      - hotel-booking-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: on-failure
    mem_limit: 512m

  # Order Service
  order-service:
    build: 
      context: .
      dockerfile: order_service/Dockerfile
    container_name: order-service
    hostname: order-service
    ports:
      - "8083:8083"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DB_USERNAME=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - EUREKA_CLIENT_SERVICE-URL_DEFAULTZONE=http://discovery-service:8671/eureka/
      - MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://zipkin:9411/api/v2/spans
      - JAVA_OPTS=-Xmx512m -Xms256m
    volumes:
      - order_logs:/app/logs
    depends_on:
      mysql-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
      - hotel-booking-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: on-failure
    mem_limit: 512m

  # Payment Service
  payment-service:
    build: 
      context: .
      dockerfile: payment_service/Dockerfile
    container_name: payment-service
    hostname: payment-service
    ports:
      - "8082:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DB_USERNAME=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - EUREKA_CLIENT_SERVICE-URL_DEFAULTZONE=http://discovery-service:8671/eureka/
      - MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://zipkin:9411/api/v2/spans
      - JAVA_OPTS=-Xmx512m -Xms256m
    volumes:
      - payment_logs:/app/logs
    depends_on:
      mysql-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
      - hotel-booking-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: on-failure
    mem_limit: 512m

volumes:
  mysql_data:
  mongo_data:
  user_logs:
  hotel_uploads:
  hotel_logs:
  order_logs:
  payment_logs:

networks:
  hotel-booking-network:
    driver: bridge
